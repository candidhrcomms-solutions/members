<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BTL Welfare Registration</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .form-input{
      width:100%;
      padding:.75rem 1rem;
      border-radius:.75rem;
      border:1px solid #d1d5db;
      outline:none;
      transition:all .2s ease;
      background:white;
    }
    .form-input:focus{
      border-color:transparent;
      box-shadow:0 0 0 2px #2563eb;
    }
    .loader { border-top-color:#2563eb; animation: spinner 1.0s linear infinite; }
    @keyframes spinner { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
  </style>
</head>

<body class="bg-slate-50 min-h-screen py-12 px-4">

  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
    <div class="bg-blue-900 px-8 py-10 text-white text-center">
      <h1 class="text-3xl font-bold uppercase tracking-wider">BTL Welfare Group</h1>
      <p class="text-blue-200 mt-2 font-light">Membership Registration Form</p>
    </div>

    <form id="registrationForm" class="p-8 space-y-10">
      <!-- hidden mode so Apps Script returns postMessage HTML -->
      <input type="hidden" name="__mode" value="iframe" />

      <!-- Honeypot anti-bot (should stay empty) -->
      <div class="hidden">
        <label>Leave this empty</label>
        <input type="text" name="website" tabindex="-1" autocomplete="off" />
      </div>

      <!-- Section A -->
      <section>
        <h2 class="text-lg font-bold text-blue-900 border-b-2 border-blue-100 pb-2 mb-6 uppercase tracking-tight">
          Section A: Personal Information
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Full Name *</label>
            <input type="text" name="fullName" required class="form-input" placeholder="John Doe" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">ID/Passport Number *</label>
            <input type="text" name="idNumber" required class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Gender *</label>
            <select name="gender" class="form-input" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Date of Birth</label>
            <input type="date" name="dob" class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Phone Number *</label>
            <input type="tel" name="phone" required class="form-input" placeholder="0712345678" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Email Address *</label>
            <input type="email" name="email" required class="form-input" placeholder="email@example.com" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Postal Address</label>
            <input type="text" name="postalAddress" class="form-input" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Physical Address / Residence</label>
            <input type="text" name="residence" class="form-input" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Occupation / Employer</label>
            <input type="text" name="occupationEmployer" class="form-input" />
          </div>
        </div>
      </section>

      <!-- Section B -->
      <section>
        <h2 class="text-lg font-bold text-blue-900 border-b-2 border-blue-100 pb-2 mb-6 uppercase tracking-tight">
          Section B: Membership Details
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Date of Joining</label>
            <input type="date" id="dateOfJoining" name="dateOfJoining" class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Membership Number (office use)</label>
            <input type="text" name="membershipNumber" class="form-input" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Next of Kin</label>
            <input type="text" name="nextOfKin" class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Relationship</label>
            <input type="text" name="relationship" class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Next of Kin Contact</label>
            <input type="tel" name="kinContact" class="form-input" />
          </div>
        </div>
      </section>

      <!-- Declaration -->
      <section class="bg-blue-50 p-6 rounded-xl border border-blue-100 space-y-4">
        <h2 class="text-sm font-bold text-blue-900 uppercase">Declaration</h2>

        <p class="text-sm text-blue-900 leading-relaxed">
          I agree to abide by the BTL constitution and code of conduct. I agree to pay the member fees of
          <strong>Ksh 5,000</strong> to the BTL Welfare Account
          <strong>MPESA Paybill 880100 Account 1006602438</strong>.
        </p>

        <div class="mt-2 flex items-start">
          <input id="confirmTerms" name="declarationAccepted" type="checkbox" required
                 class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
          <label for="confirmTerms" class="ml-2 text-sm text-gray-700">
            I confirm the information above is accurate and I accept the terms of membership.
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Applicant’s Signature (Type your full name) *</label>
            <input type="text" name="signatureName" required class="form-input" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Signature Date *</label>
            <input type="date" id="signatureDate" name="signatureDate" required class="form-input" />
          </div>
        </div>
      </section>

      <!-- Data Privacy Consent -->
      <section class="bg-white p-6 rounded-xl border border-gray-200 space-y-4">
        <h2 class="text-sm font-bold text-gray-900 uppercase">Data Privacy Consent</h2>

        <div class="text-sm text-gray-700 leading-relaxed space-y-3">
          <p>
            I, the undersigned hereby give my consent for the main committee to collect and receive my personal details
            and/or documents required for the purposes of company registration and Medical Cover.
          </p>

          <p class="font-semibold">I understand that:</p>
          <ul class="list-disc pl-6 space-y-2">
            <li>The information will be sent to the committee’s official Gmail address: <strong>btlconsulting2025@gmail.com</strong></li>
            <li>My personal details/documents will be used solely for the purpose of company registration and Medical Cover.</li>
            <li>My personal data shall be collected and processed in accordance with the Data Protection Act (DPA), 2019 and related regulations.</li>
          </ul>

          <p>
            I confirm my consent and authorize the committee to receive and use my personal details/documents for the above stated purpose. *
          </p>
        </div>

        <div class="flex items-center gap-6">
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-800">
            <input type="radio" name="consentChoice" value="Yes" required class="h-4 w-4" />
            Yes
          </label>
          <label class="flex items-center gap-2 text-sm font-semibold text-gray-800">
            <input type="radio" name="consentChoice" value="No" required class="h-4 w-4" />
            No
          </label>
        </div>
      </section>

      <!-- Submit -->
      <div class="pt-2">
        <button type="submit" id="submitBtn"
          class="w-full bg-blue-900 hover:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3">
          <span id="btnText">Submit Registration</span>
          <div id="btnLoader" class="hidden loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></div>
        </button>
      </div>

    </form>

    <div id="messageBox" class="hidden mx-8 mb-8 p-4 rounded-lg text-center font-medium"></div>
  </div>

  <script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGc-JTtbegNKx8PWMMcfDCiqDeHKHBOdQ-Jk4rMLyTaTLUTzCVZOqd4CrUly1WHKWeuA/exec";

  const form = document.getElementById("registrationForm");
  const submitBtn = document.getElementById("submitBtn");
  const btnText = document.getElementById("btnText");
  const btnLoader = document.getElementById("btnLoader");
  const messageBox = document.getElementById("messageBox");

  // Default dates to today
  function setTodayDefaults() {
    const t = new Date();
    const iso = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
    const doj = document.getElementById("dateOfJoining");
    const sig = document.getElementById("signatureDate");
    if (doj) doj.value = iso;
    if (sig) sig.value = iso;
  }
  setTodayDefaults();

  // Hidden iframe for submission (no CORS)
  const iframe = document.createElement("iframe");
  iframe.name = "hidden_iframe";
  iframe.style.display = "none";
  document.body.appendChild(iframe);

  let inFlight = false;
  let timeoutId = null;
  let gotMessage = false;

  function startUI() {
    submitBtn.disabled = true;
    btnText.textContent = "Processing...";
    btnLoader.classList.remove("hidden");
    messageBox.classList.add("hidden");
  }

  function endUI() {
    inFlight = false;
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = null;

    submitBtn.disabled = false;
    btnText.textContent = "Submit Registration";
    btnLoader.classList.add("hidden");
  }

  // Receive status from Apps Script (postMessage)
  window.addEventListener("message", (event) => {
    if (!event.data || event.data.source !== "btl_apps_script") return;

    gotMessage = true;
    endUI();

    if (event.data.ok) {
      showMessage(event.data.message || "Submitted successfully.", "success");
      form.reset();
      setTodayDefaults();
    } else {
      showMessage(event.data.message || "Submission failed.", "error");
    }
  });

  // If iframe loads, server responded. If postMessage didn't arrive, show targeted error.
  iframe.addEventListener("load", () => {
    if (!inFlight) return;

    // Wait briefly for postMessage
    setTimeout(() => {
      if (!inFlight) return; // already ended via postMessage
      endUI();

      if (!gotMessage) {
        showMessage(
          "Server responded but did not return a confirmation message. Check Apps Script → Executions to see the result.",
          "error"
        );
      }
    }, 600);
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    if (!SCRIPT_URL || !SCRIPT_URL.startsWith("https://script.google.com/macros/s/") || !SCRIPT_URL.endsWith("/exec")) {
      showMessage("Invalid backend URL configured.", "error");
      return;
    }

    if (inFlight) return;

    inFlight = true;
    gotMessage = false;
    startUI();

    form.action = SCRIPT_URL;
    form.method = "POST";
    form.target = "hidden_iframe";
    form.submit();

    timeoutId = setTimeout(() => {
      if (!inFlight) return;
      endUI();
      showMessage("No response within 30 seconds. Check Apps Script → Executions.", "error");
    }, 30000);
  });

  function showMessage(text, type) {
    messageBox.textContent = text;
    messageBox.classList.remove("hidden", "bg-green-100", "text-green-800", "bg-red-100", "text-red-800");
    if (type === "success") messageBox.classList.add("bg-green-100", "text-green-800");
    else messageBox.classList.add("bg-red-100", "text-red-800");
    messageBox.scrollIntoView({ behavior: "smooth", block: "center" });
  }
</script>

</body>
</html>
